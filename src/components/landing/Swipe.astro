---
// Assets
import { Image } from "astro:assets";
import Aelen from "@/images/work/aelen.png";
import Author from "@/images/work/author.png";
import Dusk from "@/images/work/dusk.png";
import Ellamae from "@/images/work/ellamae.png";
import Molle from "@/images/work/molle.png";
import Semplice from "@/images/work/semplice.png";
import Streamer from "@/images/work/streamer.png";

// Pre-determined swipe decisions (true = keep, false = delete)
const photos = [
  { name: "Aelen", image: Aelen, keep: true },
  { name: "Author", image: Author, keep: false },
  { name: "Dusk", image: Dusk, keep: true },
  { name: "Ellamae", image: Ellamae, keep: false },
  { name: "Molle", image: Molle, keep: true },
  { name: "Semplice", image: Semplice, keep: false },
  { name: "Streamer", image: Streamer, keep: true },
];

// Fundations
import Text from "@/components/fundations/elements/Text.astro";
import Button from "@/components/fundations/elements/Button.astro";
import Wrapper from "@/components/fundations/containers/Wrapper.astro";
// Icons
import ArrowRight from "@/components/fundations/icons/ArrowRight.astro";
import ArrowLeft from "@/components/fundations/icons/ArrowLeft.astro";
// Components
import BgGrid from "@/components/assets/BgGrid.astro";
---

<section>
  <Wrapper class="divide-y divide-white/20">
    <div class="px-8 py-6 relative">
      <BgGrid />
      <Text
        tag="h2"
        variant="displayMD"
        class="font-black text-white uppercase"
      >
      UNEXPECTEDLY THERAPEUTIC
      </Text>
    </div>
    <div class="relative">
      <div
        class="absolute inset-y-0 left-0 right-0 flex items-center justify-between px-2 pointer-events-none z-10"
      >
        <Button
          size="xs"
          iconOnly
          variant="default"
          id="swipe-slider-previous"
          aria-label="Previous slide"
          class="pointer-events-auto"
        >
          <ArrowLeft slot="icon" size="sm" />
        </Button>
        <Button
          size="xs"
          iconOnly
          variant="default"
          id="swipe-slider-next"
          aria-label="Next slide"
          class="pointer-events-auto"
        >
          <ArrowRight slot="icon" size="sm" />
        </Button>
      </div>
      <div
        id="swipe-slider"
        class="keen-slider relative divide-x divide-white/20"
      >
        {
          photos.map(({ name, image, keep }, index) => (
            <div 
              class="relative w-full keen-slider__slide swipe-photo-slide"
              data-keep={keep}
              data-index={index}
            >
              <div class="swipe-photo-wrapper relative overflow-hidden">
                <Image
                  src={image}
                  alt={name}
                  width={800}
                  height={800}
                  loading="eager"
                  decoding="async"
                  class="swipe-photo aspect-auto transition-all duration-300"
                />
                
                <!-- Swipe indicator badges -->
                <!-- Keep indicator - top right -->
                <div class="keep-badge absolute top-2 right-2 sm:top-4 sm:right-4 flex items-center gap-1 sm:gap-2 px-2 py-1 sm:px-3 sm:py-2 bg-base-950/60 backdrop-blur-sm rounded text-white opacity-0 transition-all duration-200 transform translate-x-4 pointer-events-none">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 sm:w-4 sm:h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"/>
                  </svg>
                  <span class="text-[10px] sm:text-xs font-bold uppercase tracking-wider">Saved</span>
                </div>
                <!-- Delete indicator - top left -->
                <div class="delete-badge absolute top-2 left-2 sm:top-4 sm:left-4 flex items-center gap-1 sm:gap-2 px-2 py-1 sm:px-3 sm:py-2 bg-base-950/60 backdrop-blur-sm rounded text-white/70 opacity-0 transition-all duration-200 transform -translate-x-4 pointer-events-none">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 sm:w-4 sm:h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                  </svg>
                  <span class="text-[10px] sm:text-xs font-bold uppercase tracking-wider">Gone</span>
                </div>
                
                <!-- Grayscale overlay for deleted photos -->
                <div class="delete-overlay absolute inset-0 bg-base-950/40 opacity-0 transition-opacity duration-300 pointer-events-none"></div>
              </div>
            </div>
          ))
        }
      </div>
    </div>
  </Wrapper>
</section>

<style>
  .swipe-photo-slide {
    overflow: visible;
  }
  
  .swipe-photo-wrapper {
    transform-origin: center center;
    transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  /* Swipe animation states */
  .swipe-photo-slide.swiping-right .swipe-photo-wrapper {
    transform: translateX(8px) rotate(2deg);
  }
  
  .swipe-photo-slide.swiping-left .swipe-photo-wrapper {
    transform: translateX(-8px) rotate(-2deg);
  }
  
  .swipe-photo-slide.swiping-right .keep-badge {
    opacity: 1;
    transform: translateX(0);
  }
  
  .swipe-photo-slide.swiping-left .delete-badge {
    opacity: 1;
    transform: translateX(0);
  }
  
  /* Final states after decision */
  .swipe-photo-slide.decided-delete .swipe-photo {
    filter: grayscale(100%);
    opacity: 0.5;
  }
  
  .swipe-photo-slide.decided-delete .delete-overlay {
    opacity: 1;
  }
  
  .swipe-photo-slide.decided-delete .delete-badge {
    opacity: 1;
    transform: translateX(0);
  }
  
  .swipe-photo-slide.decided-keep .swipe-photo {
    filter: none;
  }
  
  .swipe-photo-slide.decided-keep .keep-badge {
    opacity: 1;
    transform: translateX(0);
  }
</style>

<script type="module">
  import KeenSlider from "https://cdn.jsdelivr.net/npm/keen-slider@6.8.6/+esm";
  
  window.addEventListener("DOMContentLoaded", () => {
    const slides = document.querySelectorAll('.swipe-photo-slide');
    const decidedSlides = new Set();
    
    function animateSwipe(slide) {
      const index = parseInt(slide.dataset.index);
      
      // Skip if already decided
      if (decidedSlides.has(index)) return;
      
      const keep = slide.dataset.keep === 'true';
      
      // Wait in center like thinking, then show swipe animation
      setTimeout(() => {
        slide.classList.add(keep ? 'swiping-right' : 'swiping-left');
      }, 350); // "Thinking" pause before decision
      
      // Complete the decision quickly after swipe starts
      setTimeout(() => {
        slide.classList.remove('swiping-left', 'swiping-right');
        slide.classList.add(keep ? 'decided-keep' : 'decided-delete');
        decidedSlides.add(index);
        
        // Check if all slides decided, reset after a delay
        if (decidedSlides.size >= slides.length) {
          setTimeout(() => {
            resetAllSlides();
          }, 1200);
        }
      }, 550); // Quick decision after swipe
    }
    
    function resetSlide(slide) {
      slide.classList.remove('swiping-left', 'swiping-right', 'decided-keep', 'decided-delete');
    }
    
    function resetAllSlides() {
      slides.forEach(resetSlide);
      decidedSlides.clear();
    }
    
    // Keen Slider setup
    const sliderEl = document.getElementById("swipe-slider");
    if (!sliderEl) {
      console.warn("Swipe slider element not found");
      return;
    }
    
    const swipeSlider = new KeenSlider(
      sliderEl,
      {
        loop: true,
        defaultAnimation: {
          duration: 350,
        },
        detailsChanged: (s) => {
          s.slides.forEach((element, idx) => {
            element.style.opacity = s.track.details.slides[idx].portion;
          });
        },
        slideChanged: (s) => {
          // Get the current center slide and animate it
          const centerIndex = s.track.details.rel;
          const centerSlide = slides[centerIndex];
          if (centerSlide) {
            animateSwipe(centerSlide);
          }
        },
        slides: {
          origin: "center",
          perView: 1.2,
          spacing: 8,
        },
        breakpoints: {
          "(min-width: 500px)": {
            slides: {
              origin: "center",
              perView: 2.2,
              spacing: 12,
            },
          },
          "(min-width: 1024px)": {
            slides: {
              origin: "center",
              perView: 3.5,
              spacing: 0,
            },
          },
        },
      }
    );
    
    // Autoplay - advances carousel automatically
    let autoplayTimeout;
    let mouseOver = false;
    
    function scheduleNext() {
      clearTimeout(autoplayTimeout);
      if (mouseOver) return;
      autoplayTimeout = setTimeout(() => {
        swipeSlider.next();
      }, 700); // Time between slides - thinking + quick decision
    }
    
    sliderEl.addEventListener("mouseover", () => {
      mouseOver = true;
      clearTimeout(autoplayTimeout);
    });
    
    sliderEl.addEventListener("mouseout", () => {
      mouseOver = false;
      scheduleNext();
    });
    
    swipeSlider.on("animationEnded", scheduleNext);
    swipeSlider.on("created", () => {
      // Animate the initial center slide
      const centerIndex = swipeSlider.track.details.rel;
      const centerSlide = slides[centerIndex];
      if (centerSlide) {
        animateSwipe(centerSlide);
      }
      scheduleNext();
    });
    
    const swipeSliderPrevious = document.getElementById("swipe-slider-previous");
    const swipeSliderNext = document.getElementById("swipe-slider-next");
    swipeSliderPrevious?.addEventListener("click", () => swipeSlider.prev());
    swipeSliderNext?.addEventListener("click", () => swipeSlider.next());
  });
</script>
