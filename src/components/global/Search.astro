---
import { getCollection } from "astro:content";
import Button from "@/components/fundations/elements/Button.astro";
// Icons
import SearchIcon from "@/components/fundations/icons/SearchIcon.astro";
// Fetch all collections
const posts = await getCollection("posts");
const team = await getCollection("team");
const legal = await getCollection("legal");
const work = await getCollection("work");
const store = await getCollection("store");

// Map to a common format
const allContent = [
  ...posts.map((item) => ({
    title: item.data.title,
    description: item.data.description,
    pubDate: item.data.pubDate,
    slug: `/blog/posts/${item.slug}`,
    category: "Blog",
  })),
  ...team.map((item) => ({
    title: item.data.name,
    description: item.data.role || item.data.bio,
    pubDate: null,
    slug: `/team/${item.slug}`,
    category: "Team",
  })),
  ...legal.map((item) => ({
    title: item.data.page,
    description: "Legal document",
    pubDate: item.data.pubDate,
    slug: `/legal/${item.slug}`,
    category: "Legal",
  })),
  ...work.map((item) => ({
    title: item.data.title,
    description: item.data.summary,
    pubDate: null,
    slug: `/work/${item.slug}`,
    category: "Work",
  })),
  ...store.map((item) => ({
    title: item.data.title,
    description: item.data.description,
    pubDate: null,
    slug: `/store/${item.slug}`,
    category: "Store",
  })),
];
---

<div class="relative">
  <Button
    iconOnly
    size="base"
    variant="muted"
    type="button"
    id="searchButton"
    aria-label="Search site"
    class="fixed right-6 bottom-6 z-50"
  >
    <SearchIcon slot="icon" size="sm" />
  </Button>

  <div
    id="searchModal"
    class="fixed inset-0 z-50 hidden overflow-y-auto bg-black/10 backdrop-blur-sm"
    role="dialog"
    aria-modal="true"
  >
    <div class="min-h-screen px-4 text-center">
      <div
        class="relative inline-block w-full max-w-xl mt-12 mb-8 text-left align-middle lg:mt-48 transition-all transform p-8 lg:p-12 bg-base-950 bg-grid"
      >
        <div class="hidden">
          <button
            type="button"
            id="closeSearch"
            class="cursor-pointer text-base-400 hover:text-base-600"
            aria-label="Close search"
          >
            Ã—
          </button>
        </div>
        <input
          type="text"
          id="searchInput"
          placeholder="Search..."
          class="block w-full h-10 px-4 py-2 text-xs leading-tight align-middle bg-white border border-transparent  transition duration-300 ease-in-out focus:z-10 text-base-500 ring-1 ring-base-200 placeholder-base-400 focus:border-accent-50 focus:ring-accent-500 focus:ring-2 focus:outline-none shadow-sm"
        />
        <div
          id="searchResults"
          class="w-full mt-2 overflow-hidden overflow-y-auto max-h-100 divide-y divide-white/20 scrollbar-hide"
        >
        </div>
      </div>
    </div>
  </div>
</div>

<script is:inline define:vars={{ allContent }}>
  window.addEventListener("load", () => {
    const searchButton = document.getElementById("searchButton");
    const searchModal = document.getElementById("searchModal");
    const searchInput = document.getElementById("searchInput");
    const searchResults = document.getElementById("searchResults");
    const closeSearch = document.getElementById("closeSearch");

    const fuse = new Fuse(allContent, {
      keys: ["title", "description", "category"],
      threshold: 0.3,
      includeMatches: true,
    });

    searchResults.classList.add("hidden");

    function openSearch(e) {
      e.preventDefault();
      e.stopPropagation();
      searchModal.classList.remove("hidden");
      document.body.style.overflow = "hidden";
      setTimeout(() => searchInput.focus(), 100);
    }

    function closeSearchModal(e) {
      if (e) {
        e.preventDefault();
        e.stopPropagation();
      }
      searchModal.classList.add("hidden");
      document.body.style.overflow = "";
      searchInput.value = "";
      searchResults.innerHTML = "";
      searchResults.classList.add("hidden");
    }

    function renderResults(results) {
      if (!searchInput.value.trim()) {
        searchResults.innerHTML = "";
        searchResults.classList.add("hidden");
        return;
      }

      if (results.length === 0) {
        searchResults.innerHTML = `
          <div>
            <h3 class="p-4 duration-300 hover:bg-white/80 backdrop-blur bg-white/90">
              There's nothing here.
            </h3>
          </div>
        `;
        searchResults.classList.remove("hidden");
        return;
      }

      searchResults.innerHTML = results
        .map(
          (result) => `
          <div class="relative block p-4 duration-300 hover:bg-base-900 backdrop-blur bg-base-950">
            <a href="${result.item.slug}" class="absolute inset-0 z-10"></a>
            <div class="flex items-center justify-between w-full">
               <p class="block text-xs text-sm text-white font-bold">
                 ${result.item.category}
               </p>
               ${
                 result.item.pubDate
                   ? `<p class="block text-xs text-sm text-base-400">
                      ${new Date(result.item.pubDate).toLocaleDateString(
                        "en-US",
                        {
                          year: "numeric",
                          month: "long",
                          day: "2-digit",
                        }
                      )}
                    </p>`
                   : ""
               }
            </div>
            <h3 class="block mt-2 text-sm font-medium text-white ">
              ${result.item.title}
            </h3>
            <p class="block text-xs text-secondary-500">
              ${result.item.description}
            </p>
          </div>
        `
        )
        .join("");

      searchResults.classList.remove("hidden");
    }

    searchButton.addEventListener("click", openSearch);
    searchButton.addEventListener("touchend", openSearch);
    closeSearch.addEventListener("click", closeSearchModal);
    closeSearch.addEventListener("touchend", closeSearchModal);

    searchInput.addEventListener("input", (e) => {
      const value = e.target.value.trim();
      const results = value ? fuse.search(value) : [];
      renderResults(results);
    });

    // Close on escape key
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && !searchModal.classList.contains("hidden")) {
        closeSearchModal();
      }
    });

    // NEW: Click outside modal content to close
    searchModal.addEventListener("click", (e) => {
      const modalContent = e.target.closest(".inline-block");
      if (!modalContent) {
        closeSearchModal(e);
      }
    });
  });
</script>
